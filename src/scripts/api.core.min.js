(()=>{self.create=(e,t=null,s=null,o={})=>{let n=document.createElement(e);return t&&(n.className=t),s&&(n.innerHTML=s),Object.entries(o).forEach(i=>n.setAttribute(i[0],i[1])),n};HTMLElement.prototype.create=function(e,t=null,s=null,o={}){let n=create(e,t,s,o);return this.append(n),n};self.loadJsonProperties=async function(e,t={}){let s=Object.entries(t),o=await Promise.allSettled(s.map(async([n,i])=>{let r=await fetch(i),a=null;try{a=await r.json()}catch{}return{key:n,url:i,status:r.status,ok:r.ok,data:a}}));for(let n of o)if(n.status==="fulfilled"){let{key:i,url:r,status:a,ok:c,data:l}=n.value;if(!c){console.error("".concat(i," [").concat(a," - ERREUR] ").concat(r));continue}e[i]=l}else console.error("Erreur r\xE9seau/JS pendant le chargement :",n.reason);return e};self.documentReady=function(e=null){return new Promise(t=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{e&&e(),t()},{once:!0}):(e&&e(),t())})};self.loadScript=async function(e,t={},s=!1){let o=new URL(e);Object.entries(t).forEach(([i,r])=>o.searchParams.set(i,r));let n=document.createElement("script");n.src=o.toString(),n.async=s,document.head.appendChild(n)};(window.CarteSections={root:"https://docs.ssjb.com/",secrets:null,sections:null,palettes:null,container:null,postalcode:null,validmark:null,csmap:null,map:null,toolbar:null,infos:null,layer:null,features:[],polyIndex:[],init:async function(){await Promise.all([documentReady(()=>this.initContainer()),loadJsonProperties(this,{secrets:"".concat(this.root,"secrets.json"),sections:"".concat(this.root,"assets/maps/sections.json"),palettes:"".concat(this.root,"assets/maps/palettes.json")})]),this.container&&loadScript("https://maps.googleapis.com/maps/api/js",{key:this.secrets.MAPS_API_KEY,callback:"CarteSections.initMap",libraries:"geometry",loading:"async",language:"fr",region:"CA",v:"weekly"},!0)},initContainer:function(){let e=document.querySelector("carte-sections");if(!e)return;this.container=create("div","carte-sections");let t=this.container.create("div","carte-sections__header","Entrez votre <strong>code postal:&nbsp;&nbsp;</strong>");this.postalcode=t.create("input","carte-sections__header__postalcode",null,{type:"text",name:"postalcode",placeholder:"H2X 1X3",autocomplete:"off",maxLength:7,disabled:!0,required:!0,title:"Entrez un code postal valide du Qu\xE9bec (ex: H2X 1X3)",pattern:"^[GgHhJj][0-9][ABCEGHJ-NPRSTV-Zabceghj-nprstv-z][ ]?[0-9][ABCEGHJ-NPRSTV-Zabceghj-nprstv-z][0-9]$"}),this.validmark=t.create("span","carte-sections__header__validmark"),this.postalcode.addEventListener("input",()=>{let s=this.postalcode.value.replace(/\s/g,"");s.length>3&&(s=s.slice(0,3)+" "+s.slice(3)),this.postalcode.value=s.toUpperCase(),this.postalcode.checkValidity()&&(this.shake(),this.searchSection(this.postalcode.value))}),this.csmap=this.container.create("div","carte-sections__map"),this.infos=this.container.create("div","carte-sections__infos"),e.replaceWith(this.container)},initMap:async function(){let{ColorScheme:e,ControlPosition:t,LatLngBounds:s}=await google.maps.importLibrary("core"),{Map:o,Data:n}=await google.maps.importLibrary("maps");this.map=new o(this.csmap,{streetViewControl:!1,mapTypeControl:!1,zoomControl:!1,cameraControl:!1,disableDoubleClickZoom:!0,colorScheme:e.LIGHT,styles:[{elementType:"geometry",stylers:[{saturation:-80},{gamma:.85}]},{elementType:"labels.text.fill",stylers:[{saturation:-100},{lightness:-35}]},{elementType:"labels.text.stroke",stylers:[{saturation:-100},{lightness:70}]},{featureType:"road",elementType:"geometry",stylers:[{saturation:-100},{lightness:55}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{saturation:-100},{lightness:-35},{weight:1.2}]},{featureType:"road.highway",elementType:"geometry",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{saturation:-100},{gamma:.9}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"simplified"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]}]}),this.toolbar=create("div","carte-sections__map__toolbar"),this.map.controls[t.TOP_LEFT].push(this.toolbar),this.layer=new n({map:this.map}),this.layer.loadGeoJson("".concat(this.root,"assets/maps/sections.geojson"),null,async i=>{this.layer.addListener("click",a=>this.setFocus(a.feature.getProperty("id")));let r=this.getPalette(!0);i.forEach(a=>{let c=a.getProperty("id"),l=r[this.findSectionById(c).color%r.length];this.layer.overrideStyle(a,{fillColor:l,strokeColor:l,fillOpacity:.2,strokeWeight:2}),this.features[c]=a,this.dataGeomToPolygons(a.getGeometry()).forEach(u=>{let d=new s;u.getPaths().forEach(h=>h.forEach(p=>d.extend(p))),this.polyIndex.push({feature:a,poly:u,bounds:d})})}),this.postalcode.disabled=!1,this.zoomFeatures(i),this.jumpLocation()})},jumpLocation:async function(){let e=JSON.parse(sessionStorage.getItem("geolocation"));if(e)this.setFocus(this.findSectionByLatLng(e.coords.latitude,e.coords.longitude).id);else if("geolocation"in navigator)try{(await navigator.permissions?.query({name:"geolocation"})).state!=="denied"&&navigator.geolocation.getCurrentPosition(s=>{sessionStorage.setItem("geolocation",JSON.stringify(s)),this.setFocus(this.findSectionByLatLng(s.coords.latitude,s.coords.longitude).id)},null,{enableHighAccuracy:!0})}catch(t){console.error(t)}},setFocus:async function(e){let t=this.findSectionById(e);this.toolbar.style.display="block",this.toolbar.textContent="Section ".concat(t.name),this.features.hasOwnProperty(e)?(this.zoomFeatures([this.features[e]]),this.layer.overrideStyle(this.features[e],{fillOpacity:.5}),e!==this.lastSectionId&&this.features.hasOwnProperty(this.lastSectionId)&&this.layer.overrideStyle(this.features[this.lastSectionId],{fillOpacity:.2})):this.zoomFeatures(Object.values(this.features));let s=Object.fromEntries(Object.entries(t.infos).map(([n,i])=>[n,i.join(", ")])),o='<table class="section_results"><thead><tr><th colspan="2">Section '.concat(t.name,"</th></tr><thead><tbody>");o+="<tr><td>Pr\xE9sident :</td><td>".concat(s.president||"&nbsp;","</td></tr>"),o+="<tr><td>Vice-pr\xE9sident :</td><td>".concat(s.vice_president||"&nbsp;","</td></tr>"),o+="<tr><td>Secr\xE9taire :</td><td>".concat(s.secretaire||"&nbsp;","</td></tr>"),o+="<tr><td>Tr\xE9sorier :</td><td>".concat(s.tresorier||"&nbsp;","</td></tr>"),o+="<tr><td>Conseiller jeunesse :</td><td>".concat(s.conseiller_jeunesse||"&nbsp;","</td></tr>"),o+="<tr><td>Conseillers :</td><td>".concat(s.conseillers||"&nbsp;","</td></tr>"),o+='<tr><td>Contact :</td><td><a href="mailto:'.concat(t.email,'">').concat(t.email,"</a></td></tr>"),o+="</tbody></table>",this.infos.innerHTML=o,this.lastSectionId=e},dataGeomToPolygons:function(e){let t=[],s=e.getType();return s==="Polygon"?t.push(new google.maps.Polygon({paths:e.getArray().map(o=>o.getArray())})):s==="MultiPolygon"&&e.getArray().forEach(o=>t.push(new google.maps.Polygon({paths:o.getArray().map(n=>n.getArray())}))),t},zoomFeatures:async function(e=[]){let t=new google.maps.LatLngBounds;e.forEach(s=>s.getGeometry().forEachLatLng(o=>t.extend(o))),t.isEmpty()||this.map.fitBounds(t)},searchSection:async function(e){let t=this.findSectionByPostalCode(e);if(t)this.setFocus(t.id);else{let s=await this.getGeocode(e);if(s.status!="OK")this.setFocus(this.sections.defaultSection.id),console.error(this.statusMessage(s.status));else{let{lat:o,lng:n}=s.results[0].geometry.location,i=this.findSectionByLatLng(o,n);this.setFocus(i.id)}}},findSectionByPostalCode:function(e){return e=e.trim().replace(/^([A-Z][0-9][A-Z])\s?([0-9][A-Z][0-9][A-Z][0-9])$/i,"$1 $2").toUpperCase(),this.sections.defaultSection.postalcodes.includes(e)?this.sections.defaultSection:this.sections.sections.find(s=>Array.isArray(s.postalcodes)&&s.postalcodes.includes(e))||null},findSectionById:function(e){return this.sections.sections.find(s=>s.id==e)||this.sections.defaultSection||null},findSectionByLatLng:function(e,t){let s=this.findContainingFeature({lat:e,lng:t});if(!s)return this.sections.defaultSection||null;let o=s.getProperty("id");return this.sections.sections.find(n=>n.id==o)},findContainingFeature:function(e){for(let{feature:t,poly:s,bounds:o}of this.polyIndex)if(o.contains(e)&&google.maps.geometry.poly.containsLocation(e,s))return t;return null},getGeocode:async function(e,t=null){let s="geocoder_"+e.replace(/[^A-Z0-9]/,"").toLowerCase();if((t=sessionStorage.getItem(s))!==null)return JSON.parse(t);let o=new URL("https://maps.googleapis.com/maps/api/geocode/json");o.searchParams.set("components","country:CA|postal_code:".concat(e.replace(/[^A-Z0-9]/g,""))),o.searchParams.set("language","fr-CA"),o.searchParams.set("key",this.secrets.MAPS_API_KEY);let n=await fetch(o);if(!n.ok)throw new Error("HTTP ".concat(n.status));if(!(t=await n.json()))throw new Error("Bad request response format.");return sessionStorage.setItem(s,JSON.stringify(t)),this.saveGeocodeRequest(s,t),t},saveGeocodeRequest:function(e,t){fetch("https://script.google.com/macros/s/".concat(this.secrets.KV_API_KEY,"/exec"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({key:e,value:JSON.stringify(t)})})},statusMessage:function(e,t){switch(e){case"OVER_DAILY_LIMIT":case"OVER_QUERY_LIMIT":return"Quota d\xE9pass\xE9. V\xE9rifiez la facturation/quota sur Google Cloud.";case"REQUEST_DENIED":return"Requ\xEAte refus\xE9e. V\xE9rifiez les restrictions de la cl\xE9 API (HTTP referrer) et l\u2019activation de l\u2019API Geocoding.";case"INVALID_REQUEST":return"Requ\xEAte invalide. Param\xE8tres manquants ou mal form\xE9s.";case"UNKNOWN_ERROR":return"Erreur inconnue c\xF4t\xE9 Google. R\xE9essayez.";case"ZERO_RESULTS":return"Aucun r\xE9sultat pour ce code postal.";default:return t||"Statut inattendu: ".concat(e||"inconnu")}},getPalette:function(e=!1){return this.palettes.light[e?"full":"partial"]},shake:async function(){this.postalcode.classList.add("shake"),setTimeout(()=>this.postalcode.classList.remove("shake"),500)}}).init();})();
