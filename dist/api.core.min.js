/*!

    ██╗   ██╗██╗      ██████╗ ██╗     ██╗
    ██║   ██║██║     ██╔═══██╗██║     ██║
    ██║   ██║██║     ██║   ██║██║     ██║
    ╚██╗ ██╔╝██║     ██║▄▄ ██║██║     ╚═╝
     ╚████╔╝ ███████╗╚██████╔╝███████╗██╗
      ╚═══╝  ╚══════╝ ╚══▀▀═╝ ╚══════╝╚═╝

    Généré: Lundi le 2 février 2026 à 21 h 30
    Auteur: Maxime Larrivée-Roy <mlarriveeroy@gmail.com>
    Github: https://github.com/ssjbm/api-carte-sections

*/
(()=>{const d=new CSSStyleSheet;d.replaceSync(':root{--cs-width:100%;--cs-aspect-ratio:4/3;--cs-color-highlight:#537ea8;--cs-color-even:#537ea859}.carte-sections{position:relative;display:flex;flex-direction:column;width:var(--cs-width)}.carte-sections__header{line-height:2em;white-space:nowrap}.carte-sections__header__postalcode{font-size:1em!important;text-align:center;text-transform:uppercase;width:5em;border:1px solid #000}.carte-sections__header__postalcode:focus{border-width:2px}.carte-sections__header__postalcode::placeholder{opacity:.4}.carte-sections__header__postalcode.shake{filter:blur(.01rem);animation-name:cs-shake;animation-duration:50ms;animation-iteration-count:infinite;animation-timing-function:linear;transform-origin:center center}.carte-sections__header__validmark::before{margin:0 .25em}.carte-sections__header:has(.carte-sections__header__postalcode:placeholder-shown) .carte-sections__header__validmark{display:none}.carte-sections__header:has(.carte-sections__header__postalcode:valid) .carte-sections__header__validmark::before{content:"\u2705"}.carte-sections__header:has(.carte-sections__header__postalcode:invalid) .carte-sections__header__validmark::before{content:"\u274C"}.carte-sections__map{position:relative;margin-top:.5em;aspect-ratio:var(--cs-aspect-ratio);box-shadow:0 .2em 1em rgba(0,0,0,.35)}.carte-sections__map__toolbar{background-color:var(--cs-color-highlight);margin-top:.6em;margin-left:.6em;font-size:1.1rem;font-weight:700;padding:.3em .5em;box-shadow:0 .2em .5em rgba(0,0,0,.35);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 70px);user-select:none;display:none;-webkit-appearance:none;appearance:none}@media (max-width:576px){.carte-sections__map__toolbar{visibility:hidden}}.carte-sections__infos{margin-top:1.5em;font-size:.9em}.carte-sections__infos table th,.carte-sections__infos table td{padding:.2em}.carte-sections__infos table th{text-align:left;font-size:1.3em;background-color:var(--cs-color-highlight)}.carte-sections__infos table tr:nth-child(even) td{background-color:var(--cs-color-even)}.carte-sections__infos table tr td:first-child{line-height:1.5em;width:1%;white-space:nowrap;padding-right:1em;font-weight:700;vertical-align:top}@keyframes cs-shake{0%{transform:translate(-1%,1%) rotate(-3deg)}to{transform:translate(1%,-1%) rotate(3deg)}}'),document.adoptedStyleSheets=[...document.adoptedStyleSheets,d],self.create=(e,t=null,s=null,o={})=>{let a=document.createElement(e);return t&&(a.className=t),s&&(a.innerHTML=s),Object.entries(o).forEach(n=>a.setAttribute(n[0],n[1])),a},HTMLElement.prototype.create=function(e,t=null,s=null,o={}){let a=create(e,t,s,o);return this.append(a),a},self.loadJsonProperties=async function(e,t={}){let s=Object.entries(t),o=await Promise.allSettled(s.map(async([a,n])=>{let r=await fetch(n),i=null;try{i=await r.json()}catch{}return{key:a,url:n,status:r.status,ok:r.ok,data:i}}));for(let a of o)if(a.status==="fulfilled"){let{key:n,url:r,status:i,ok:c,data:l}=a.value;if(!c){console.error("".concat(n," [").concat(i," - ERREUR] ").concat(r));continue}e[n]=l}else console.error("Erreur r\xE9seau/JS pendant le chargement :",a.reason);return e},self.documentReady=function(e=null){return new Promise(t=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{e&&e(),t()},{once:!0}):(e&&e(),t())})},self.loadScript=async function(e,t={},s=!1){let o=new URL(e);Object.entries(t).forEach(([n,r])=>o.searchParams.set(n,r));let a=document.createElement("script");a.src=o.toString(),a.async=s,document.head.appendChild(a)},(window.CarteSections={root:"https://docs.ssjb.com/",secrets:null,sections:null,palettes:null,container:null,postalcode:null,validmark:null,csmap:null,map:null,toolbar:null,infos:null,layer:null,features:[],polyIndex:[],init:async function(){await Promise.all([documentReady(()=>this.initContainer()),loadJsonProperties(this,{secrets:"".concat(this.root,"secrets.json"),sections:"".concat(this.root,"assets/maps/sections.json"),palettes:"".concat(this.root,"assets/maps/palettes.json")})]),this.container&&loadScript("https://maps.googleapis.com/maps/api/js",{key:this.secrets.MAPS_API_KEY,callback:"CarteSections.initMap",libraries:"geometry",loading:"async",language:"fr",region:"CA",v:"weekly"},!0)},initContainer:function(){let e=document.querySelector("carte-sections");if(!e)return;this.container=create("div","carte-sections");let t=this.container.create("div","carte-sections__header","Entrez votre <strong>code postal:&nbsp;&nbsp;</strong>");this.postalcode=t.create("input","carte-sections__header__postalcode",null,{type:"text",name:"postalcode",placeholder:"H2X 1X3",autocomplete:"off",maxLength:7,disabled:!0,required:!0,title:"Entrez un code postal valide du Qu\xE9bec (ex: H2X 1X3)",pattern:"^[GgHhJj][0-9][ABCEGHJ-NPRSTV-Zabceghj-nprstv-z][ ]?[0-9][ABCEGHJ-NPRSTV-Zabceghj-nprstv-z][0-9]$"}),this.validmark=t.create("span","carte-sections__header__validmark"),this.postalcode.addEventListener("input",()=>{let s=this.postalcode.value.replace(/\s/g,"");s.length>3&&(s=s.slice(0,3)+" "+s.slice(3)),this.postalcode.value=s.toUpperCase(),this.postalcode.checkValidity()&&(this.shake(),this.searchSection(this.postalcode.value))}),this.csmap=this.container.create("div","carte-sections__map"),this.infos=this.container.create("div","carte-sections__infos"),e.replaceWith(this.container)},initMap:async function(){let{ColorScheme:e,ControlPosition:t,LatLngBounds:s}=await google.maps.importLibrary("core"),{Map:o,Data:a}=await google.maps.importLibrary("maps");this.map=new o(this.csmap,{streetViewControl:!1,mapTypeControl:!1,disableDoubleClickZoom:!0,colorScheme:e.LIGHT,styles:[{elementType:"geometry",stylers:[{saturation:-80},{gamma:.85}]},{elementType:"labels.text.fill",stylers:[{saturation:-100},{lightness:-35}]},{elementType:"labels.text.stroke",stylers:[{saturation:-100},{lightness:70}]},{featureType:"road",elementType:"geometry",stylers:[{saturation:-100},{lightness:55}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{saturation:-100},{lightness:-35},{weight:1.2}]},{featureType:"road.highway",elementType:"geometry",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{saturation:-100},{gamma:.9}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"simplified"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]}]}),this.toolbar=create("div","carte-sections__map__toolbar"),this.map.controls[t.TOP_LEFT].push(this.toolbar),this.layer=new a({map:this.map}),this.layer.loadGeoJson("".concat(this.root,"assets/maps/sections.geojson"),null,async n=>{this.layer.addListener("click",i=>this.setFocus(i.feature.getProperty("id")));let r=this.getPalette(!0);n.forEach(i=>{let c=i.getProperty("id"),l=r[this.findSectionById(c).color%r.length];this.layer.overrideStyle(i,{fillColor:l,strokeColor:l,fillOpacity:.2,strokeWeight:2}),this.features[c]=i,this.dataGeomToPolygons(i.getGeometry()).forEach(h=>{let u=new s;h.getPaths().forEach(p=>p.forEach(m=>u.extend(m))),this.polyIndex.push({feature:i,poly:h,bounds:u})})}),this.postalcode.disabled=!1,this.zoomFeatures(n),this.jumpLocation()})},jumpLocation:async function(){let e=JSON.parse(sessionStorage.getItem("geolocation"));if(e)this.setFocus(this.findSectionByLatLng(e.coords.latitude,e.coords.longitude).id);else if("geolocation"in navigator)try{(await navigator.permissions?.query({name:"geolocation"})).state!=="denied"&&navigator.geolocation.getCurrentPosition(t=>{sessionStorage.setItem("geolocation",JSON.stringify(t)),this.setFocus(this.findSectionByLatLng(t.coords.latitude,t.coords.longitude).id)},null,{enableHighAccuracy:!0})}catch(t){console.error(t)}},setFocus:async function(e){let t=this.findSectionById(e);this.toolbar.style.display="block",this.toolbar.textContent="Section ".concat(t.name),this.features.hasOwnProperty(e)?(this.zoomFeatures([this.features[e]]),this.layer.overrideStyle(this.features[e],{fillOpacity:.5}),e!==this.lastSectionId&&this.features.hasOwnProperty(this.lastSectionId)&&this.layer.overrideStyle(this.features[this.lastSectionId],{fillOpacity:.2})):this.zoomFeatures(Object.values(this.features));let s=Object.fromEntries(Object.entries(t.infos).map(([a,n])=>[a,n.join(", ")])),o='<table class="section_results"><thead><tr><th colspan="2">Section '.concat(t.name,"</th></tr><thead><tbody>");o+="<tr><td>Pr\xE9sident :</td><td>".concat(s.president||"&nbsp;","</td></tr>"),o+="<tr><td>Vice-pr\xE9sident :</td><td>".concat(s.vice_president||"&nbsp;","</td></tr>"),o+="<tr><td>Secr\xE9taire :</td><td>".concat(s.secretaire||"&nbsp;","</td></tr>"),o+="<tr><td>Tr\xE9sorier :</td><td>".concat(s.tresorier||"&nbsp;","</td></tr>"),o+="<tr><td>Conseiller jeunesse :</td><td>".concat(s.conseiller_jeunesse||"&nbsp;","</td></tr>"),o+="<tr><td>Conseillers :</td><td>".concat(s.conseillers||"&nbsp;","</td></tr>"),o+='<tr><td>Contact :</td><td><a href="mailto:'.concat(t.email,'">').concat(t.email,"</a></td></tr>"),o+="</tbody></table>",this.infos.innerHTML=o,this.lastSectionId=e},dataGeomToPolygons:function(e){let t=[],s=e.getType();return s==="Polygon"?t.push(new google.maps.Polygon({paths:e.getArray().map(o=>o.getArray())})):s==="MultiPolygon"&&e.getArray().forEach(o=>t.push(new google.maps.Polygon({paths:o.getArray().map(a=>a.getArray())}))),t},zoomFeatures:async function(e=[]){let t=new google.maps.LatLngBounds;e.forEach(s=>s.getGeometry().forEachLatLng(o=>t.extend(o))),t.isEmpty()||this.map.fitBounds(t)},searchSection:async function(e){let t=this.findSectionByPostalCode(e);if(t)this.setFocus(t.id);else{let s=await this.getGeocode(e);if(s.status!="OK")this.setFocus(this.sections.defaultSection.id),console.error(this.statusMessage(s.status));else{let{lat:o,lng:a}=s.results[0].geometry.location,n=this.findSectionByLatLng(o,a);this.setFocus(n.id)}}},findSectionByPostalCode:function(e){return e=e.trim().replace(/^([A-Z][0-9][A-Z])\s?([0-9][A-Z][0-9][A-Z][0-9])$/i,"$1 $2").toUpperCase(),this.sections.defaultSection.postalcodes.includes(e)?this.sections.defaultSection:this.sections.sections.find(t=>Array.isArray(t.postalcodes)&&t.postalcodes.includes(e))||null},findSectionById:function(e){return this.sections.sections.find(t=>t.id==e)||this.sections.defaultSection||null},findSectionByLatLng:function(e,t){let s=this.findContainingFeature({lat:e,lng:t});if(!s)return this.sections.defaultSection||null;let o=s.getProperty("id");return this.sections.sections.find(a=>a.id==o)},findContainingFeature:function(e){for(let{feature:t,poly:s,bounds:o}of this.polyIndex)if(o.contains(e)&&google.maps.geometry.poly.containsLocation(e,s))return t;return null},getGeocode:async function(e,t=null){let s="geocoder_"+e.replace(/[^A-Z0-9]/,"").toLowerCase();if((t=sessionStorage.getItem(s))!==null)return JSON.parse(t);let o=new URL("https://maps.googleapis.com/maps/api/geocode/json");o.searchParams.set("components","country:CA|postal_code:".concat(e.replace(/[^A-Z0-9]/g,""))),o.searchParams.set("language","fr-CA"),o.searchParams.set("key",this.secrets.MAPS_API_KEY);let a=await fetch(o);if(!a.ok)throw new Error("HTTP ".concat(a.status));if(!(t=await a.json()))throw new Error("Bad request response format.");return sessionStorage.setItem(s,JSON.stringify(t)),this.saveGeocodeRequest(s,t),t},saveGeocodeRequest:function(e,t){fetch("https://script.google.com/macros/s/".concat(this.secrets.KV_API_KEY,"/exec"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({key:e,value:JSON.stringify(t)})})},statusMessage:function(e,t){switch(e){case"OVER_DAILY_LIMIT":case"OVER_QUERY_LIMIT":return"Quota d\xE9pass\xE9. V\xE9rifiez la facturation/quota sur Google Cloud.";case"REQUEST_DENIED":return"Requ\xEAte refus\xE9e. V\xE9rifiez les restrictions de la cl\xE9 API (HTTP referrer) et l\u2019activation de l\u2019API Geocoding.";case"INVALID_REQUEST":return"Requ\xEAte invalide. Param\xE8tres manquants ou mal form\xE9s.";case"UNKNOWN_ERROR":return"Erreur inconnue c\xF4t\xE9 Google. R\xE9essayez.";case"ZERO_RESULTS":return"Aucun r\xE9sultat pour ce code postal.";default:return t||"Statut inattendu: ".concat(e||"inconnu")}},getPalette:function(e=!1){return this.palettes.light[e?"full":"partial"]},shake:async function(){this.postalcode.classList.add("shake"),setTimeout(()=>this.postalcode.classList.remove("shake"),500)}}).init()})();
